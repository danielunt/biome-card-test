<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Biome QR Card Lookup & Claim</title>
    <style>
      :root {
        --bg: #050816;
        --panel: #0f172a;
        --accent: #facc15;
        --accent-glow: rgba(250, 204, 21, 0.55);
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --danger: #f87171;
        --radius-lg: 18px;
        --radius-md: 10px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, sans-serif;
        background: #020617;
        color: var(--text-main);
        display: flex;
        justify-content: center;
        padding: 14px;
      }

      .page {
        width: 100%;
        max-width: 480px; /* mobile-first */
      }

      .shell {
        background: #030712;
        border-radius: 24px;
        padding: 16px;
        border: 1px solid rgba(250, 204, 21, 0.25);
        box-shadow: 0 0 32px rgba(250, 204, 21, 0.18);
      }

      .header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .logo-dot {
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #fff8e1, #facc15);
        box-shadow: 0 0 26px var(--accent-glow);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: #422006;
      }

      h1 {
        margin: 0;
        font-size: 0.95rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .sub {
        margin: 1px 0 0;
        font-size: 0.7rem;
        color: var(--text-muted);
      }

      .panel {
        background: var(--panel);
        border-radius: var(--radius-lg);
        padding: 12px 12px 10px;
        margin-top: 10px;
        border: 1px solid rgba(148, 163, 184, 0.25);
      }

      h2 {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin: 0 0 8px;
        color: var(--accent);
      }

      label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      input {
        width: 100%;
        padding: 8px 10px;
        margin-bottom: 9px;
        background: #020617;
        color: var(--text-main);
        border-radius: var(--radius-md);
        border: 1px solid rgba(250, 204, 21, 0.5);
        font-size: 0.85rem;
        outline: none;
      }

      input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 6px var(--accent-glow);
      }

      button {
        width: 100%;
        padding: 9px 10px;
        margin-top: 6px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: 0.15s;
      }

      .btn-primary {
        background: var(--accent);
        color: #422006;
        font-weight: 600;
        box-shadow: 0 4px 14px rgba(250, 204, 21, 0.35);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(250, 204, 21, 0.5);
      }

      .btn-ghost {
        background: none;
        color: var(--accent);
        border: 1px solid var(--accent);
      }

      .btn-ghost:hover {
        background: rgba(250, 204, 21, 0.08);
      }

      button:disabled {
        opacity: 0.5;
        box-shadow: none;
        transform: none;
        cursor: default;
      }

      .status {
        font-size: 0.75rem;
        margin-top: 6px;
        color: var(--text-muted);
      }

      .status.ok {
        color: var(--accent);
      }

      .status.error {
        color: var(--danger);
      }

      .card-panel {
        background: #020617;
        border-radius: var(--radius-lg);
        padding: 11px;
        border: 1px solid rgba(250, 204, 21, 0.25);
        box-shadow: 0 0 18px rgba(250, 204, 21, 0.12);
      }

      .card-empty {
        font-size: 0.8rem;
        font-style: italic;
        color: var(--text-muted);
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .card-rarity {
        font-size: 0.7rem;
        letter-spacing: 0.08em;
        color: var(--accent);
      }

      .card-owner-label {
        font-size: 0.75rem;
        color: var(--text-muted);
      }

      .card-owner {
        font-size: 0.8rem;
        color: var(--accent);
        font-weight: 500;
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>

  <body>
    <div class="page">
      <div class="shell">
        <div class="header">
          <div class="logo-dot">B</div>
          <div>
            <h1>Biome QR Registry</h1>
            <div class="sub">Scan · Look Up · Claim Ownership</div>
          </div>
        </div>

        <!-- Account -->
        <div class="panel">
          <h2>Account</h2>
          <label>Email</label>
          <input id="email" type="email" />
          <label>Password</label>
          <input id="password" type="password" />
          <button id="login" class="btn-primary">Log in / Sign up</button>
          <div id="auth-status" class="status"></div>
        </div>

        <!-- Username -->
        <div class="panel">
          <h2>Username</h2>
          <input id="username" placeholder="Pick a username" />
          <button id="save-username" class="btn-ghost">Save username</button>
          <div id="username-status" class="status"></div>
        </div>

        <!-- Lookup -->
        <div class="panel">
          <h2>Card Lookup</h2>
          <label>UID</label>
          <input id="uid" placeholder="TEST-001" />
          <button id="lookup" class="btn-primary">Lookup card</button>
        </div>

        <!-- Card -->
        <div class="panel">
          <h2>Card</h2>
          <div class="card-panel">
            <div id="card-empty" class="card-empty">
              No card loaded yet. Scan a QR or enter a UID.
            </div>
            <div id="card-content" style="display: none">
              <div class="card-title" id="card-name"></div>
              <div class="card-rarity" id="card-rarity"></div>
              <div style="margin-top: 8px">
                <span class="card-owner-label">Registered to: </span>
                <span class="card-owner" id="card-owner"></span>
              </div>
            </div>
          </div>
          <button id="claim" class="btn-primary" disabled>
            Claim this card
          </button>
          <div id="claim-status" class="status"></div>
        </div>
      </div>
    </div>

    <script>
      const SUPABASE_URL = "https://owzdmecflzxdfbtxvfmb.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93emRtZWNmbHp4ZGZidHh2Zm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3OTY3ODYsImV4cCI6MjA3OTM3Mjc4Nn0.fUa-kAsMP-j_1QM63pgb7oX4wyuJPuZ2touDHNbtMkM";
      const TABLE_NAME = "QR Data";

      const { createClient } = supabase;
      const db = createClient(SUPABASE_URL, SUPABASE_KEY);

      let currentCardUID = null;

      const authStatusEl = document.getElementById("auth-status");
      const usernameStatusEl = document.getElementById("username-status");
      const claimStatusEl = document.getElementById("claim-status");

      const cardEmpty = document.getElementById("card-empty");
      const cardContent = document.getElementById("card-content");
      const cardName = document.getElementById("card-name");
      const cardRarity = document.getElementById("card-rarity");
      const cardOwner = document.getElementById("card-owner");

      async function refreshAuthStatus() {
        const { data } = await db.auth.getSession();
        if (data.session?.user) {
          authStatusEl.textContent = `Logged in as: ${data.session.user.email}`;
          authStatusEl.className = "status ok";
        } else {
          authStatusEl.textContent = "Not logged in.";
          authStatusEl.className = "status";
        }
      }

      document.getElementById("login").onclick = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        let { data, error } = await db.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          let signup = await db.auth.signUp({ email, password });
          if (signup.error) {
            authStatusEl.textContent = "Login/signup failed.";
            authStatusEl.className = "status error";
          } else {
            authStatusEl.textContent = "Account created.";
            authStatusEl.className = "status ok";
          }
        } else {
          authStatusEl.textContent = `Logged in as: ${data.user.email}`;
          authStatusEl.className = "status ok";
        }

        refreshAuthStatus();
        loadUsername();
      };

      async function loadUsername() {
        const input = document.getElementById("username");
        input.value = "";

        const { data } = await db.auth.getSession();
        const user = data.session?.user;
        if (!user) {
          usernameStatusEl.textContent = "Log in to set a username.";
          usernameStatusEl.className = "status";
          return;
        }

        const { data: profile } = await db
          .from("profiles")
          .select("username")
          .eq("id", user.id)
          .maybeSingle();

        if (profile?.username) {
          input.value = profile.username;
          usernameStatusEl.textContent = "Username saved.";
          usernameStatusEl.className = "status ok";
        } else {
          usernameStatusEl.textContent = "Choose a username.";
          usernameStatusEl.className = "status";
        }
      }

      document.getElementById("save-username").onclick = async () => {
        const name = document.getElementById("username").value.trim();

        const { data } = await db.auth.getSession();
        const user = data.session?.user;
        if (!user) {
          usernameStatusEl.textContent = "Log in first.";
          usernameStatusEl.className = "status error";
          return;
        }

        const { error } = await db
          .from("profiles")
          .upsert({ id: user.id, username: name });

        if (error) {
          usernameStatusEl.textContent = "Username taken.";
          usernameStatusEl.className = "status error";
        } else {
          usernameStatusEl.textContent = "Saved.";
          usernameStatusEl.className = "status ok";
        }
      };

      function showEmpty(text) {
        cardEmpty.textContent = text;
        cardEmpty.style.display = "block";
        cardContent.style.display = "none";
      }

      function showCard(n, r, o) {
        cardName.textContent = n;
        cardRarity.textContent = r.toUpperCase();
        cardOwner.textContent = o;
        cardEmpty.style.display = "none";
        cardContent.style.display = "block";
      }

      document.getElementById("lookup").onclick = async () => {
        const uid = document.getElementById("uid").value.trim();
        if (!uid) return showEmpty("Enter a UID.");

        currentCardUID = uid;
        showEmpty("Loading…");

        const { data } = await db
          .from(TABLE_NAME)
          .select("*")
          .eq("uid", uid)
          .maybeSingle();

        if (!data) return showEmpty("Card not found.");

        let ownerText = "(unregistered)";

        if (data.registered_to) {
          const { data: profile } = await db
            .from("profiles")
            .select("username")
            .eq("id", data.registered_to)
            .maybeSingle();

          const { data: session } = await db.auth.getSession();
          const currentUser = session.session?.user;

          if (currentUser && currentUser.id === data.registered_to) {
            ownerText = (profile?.username || "(no username)") + " (you)";
          } else {
            ownerText = profile?.username || "Another player";
          }
        }

        showCard(data.card_name, data.rarity, ownerText);
        document.getElementById("claim").disabled = !!data.registered_to;
      };

      document.getElementById("claim").onclick = async () => {
        const { data: session } = await db.auth.getSession();
        const user = session.session?.user;

        if (!user) {
          claimStatusEl.textContent = "Log in first.";
          claimStatusEl.className = "status error";
          return;
        }

        const { data } = await db
          .from(TABLE_NAME)
          .update({
            registered_to: user.id,
            registered_at: new Date().toISOString(),
          })
          .eq("uid", currentCardUID)
          .is("registered_to", null)
          .select()
          .maybeSingle();

        if (!data) {
          claimStatusEl.textContent = "Too late. Someone claimed it.";
          claimStatusEl.className = "status error";
          return;
        }

        claimStatusEl.textContent = "You claimed this card!";
        claimStatusEl.className = "status ok";
        document.getElementById("claim").disabled = true;
        document.getElementById("lookup").click();
      };

      (function autoLoad() {
        const params = new URLSearchParams(window.location.search);
        const uid = params.get("uid");
        if (uid) {
          document.getElementById("uid").value = uid;
          document.getElementById("lookup").click();
        } else {
          showEmpty("Scan a QR or enter a UID.");
        }
      })();

      refreshAuthStatus();
      loadUsername();
    </script>
  </body>
</html>
