<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Biome QR Card Lookup & Claim</title>
    <style>
      :root {
        --bg: #050816;
        --panel: #0f172a;
        --panel-soft: #111827;
        --accent: #22c55e;
        --accent-soft: rgba(34, 197, 94, 0.16);
        --accent-alt: #38bdf8;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --danger: #f97373;
        --radius-lg: 18px;
        --radius-md: 10px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: radial-gradient(circle at top, #0b1120, #020617 52%);
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .page {
        width: 100%;
        max-width: 520px;
      }

      .shell {
        background: linear-gradient(145deg, #020617, #020617 32%, #0f172a);
        border-radius: 26px;
        padding: 18px;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.18);
      }

      .header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }

      .logo-dot {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 15%, #f9fafb, #22c55e);
        box-shadow: 0 0 30px rgba(34, 197, 94, 0.55);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        font-weight: 700;
        color: #052e16;
      }

      .title-wrap h1 {
        font-size: 1.15rem;
        letter-spacing: 0.06em;
        margin: 0;
        text-transform: uppercase;
        color: #f9fafb;
      }

      .title-wrap p {
        margin: 2px 0 0;
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 14px;
      }

      @media (max-width: 720px) {
        .shell {
          padding: 16px;
        }
        .grid {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .panel {
        background: var(--panel);
        border-radius: var(--radius-lg);
        padding: 14px 14px 12px;
        border: 1px solid rgba(148, 163, 184, 0.18);
      }

      .panel + .panel {
        margin-top: 10px;
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      .panel-header h2 {
        margin: 0;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
      }

      .chip {
        padding: 2px 7px;
        border-radius: 999px;
        font-size: 0.65rem;
        border: 1px solid rgba(148, 163, 184, 0.4);
        color: var(--text-muted);
      }

      label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      input {
        width: 100%;
        padding: 7px 9px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(148, 163, 184, 0.5);
        background: #020617;
        color: var(--text-main);
        font-size: 0.8rem;
        outline: none;
      }

      input::placeholder {
        color: rgba(148, 163, 184, 0.7);
      }

      input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.6);
      }

      button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 7px 11px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        transition: all 0.15s ease-out;
      }

      .btn-primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #022c22;
        box-shadow: 0 8px 18px rgba(34, 197, 94, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 22px rgba(34, 197, 94, 0.55);
      }

      .btn-ghost {
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-muted);
        border: 1px solid rgba(148, 163, 184, 0.4);
      }

      .btn-ghost:hover {
        border-color: var(--accent-alt);
        color: var(--accent-alt);
        box-shadow: 0 0 18px rgba(56, 189, 248, 0.5);
      }

      button:disabled {
        opacity: 0.55;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .button-row {
        display: flex;
        gap: 6px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .status {
        font-size: 0.75rem;
        margin-top: 5px;
        color: var(--text-muted);
      }

      .status.ok {
        color: var(--accent);
      }

      .status.error {
        color: var(--danger);
      }

      .card-panel {
        background: radial-gradient(circle at top left, #022c22, #020617);
        border-radius: var(--radius-lg);
        padding: 12px 12px 10px;
        border: 1px solid rgba(34, 197, 94, 0.4);
        box-shadow: 0 0 35px rgba(34, 197, 94, 0.35);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 6px;
      }

      .card-title {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .card-meta {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--accent-alt);
      }

      .card-body-line {
        font-size: 0.8rem;
        margin-bottom: 2px;
      }

      .card-body-label {
        color: var(--text-muted);
      }

      .card-empty {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-style: italic;
      }

      .claim-row {
        display: flex;
        gap: 6px;
        margin-top: 8px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="page">
      <div class="shell">
        <div class="header">
          <div class="logo-dot">B</div>
          <div class="title-wrap">
            <h1>Biome QR Registry</h1>
            <p>Scan · Lookup · Claim your physical cards</p>
          </div>
        </div>

        <div class="grid">
          <!-- LEFT: account + username -->
          <div>
            <div class="panel">
              <div class="panel-header">
                <h2>Account</h2>
                <span class="chip">Supabase Auth</span>
              </div>
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" />
              <label for="password">Password</label>
              <input
                id="password"
                type="password"
                placeholder="Your password"
              />
              <div class="button-row">
                <button id="login" class="btn-primary">Log in / Sign up</button>
              </div>
              <div id="auth-status" class="status"></div>
            </div>

            <div class="panel" style="margin-top: 10px">
              <div class="panel-header">
                <h2>Username</h2>
                <span class="chip">Public Name</span>
              </div>
              <input id="username" placeholder="Pick a username" />
              <div class="button-row">
                <button id="save-username" class="btn-ghost">
                  Save username
                </button>
              </div>
              <div id="username-status" class="status"></div>
            </div>
          </div>

          <!-- RIGHT: lookup + card -->
          <div>
            <div class="panel">
              <div class="panel-header">
                <h2>Card Lookup</h2>
                <span class="chip">UID Scan</span>
              </div>
              <label for="uid">UID</label>
              <input id="uid" placeholder="e.g. TEST-001" />
              <div class="button-row">
                <button id="lookup" class="btn-primary">Lookup Card</button>
              </div>
            </div>

            <div class="panel" style="margin-top: 10px">
              <div class="panel-header">
                <h2>Card</h2>
                <span class="chip">Bound to QR</span>
              </div>
              <div id="card-shell" class="card-panel">
                <div class="card-empty" id="card-empty">
                  No card loaded yet. Scan a QR or enter a UID.
                </div>
                <div id="card-content" style="display: none">
                  <div class="card-header">
                    <div class="card-title" id="card-name">Card Name</div>
                    <div class="card-meta" id="card-rarity">RARITY</div>
                  </div>
                  <div class="card-body-line">
                    <span class="card-body-label">Registered to: </span
                    ><span id="card-owner">—</span>
                  </div>
                </div>
              </div>
              <div class="claim-row">
                <button id="claim" class="btn-primary" disabled>
                  Claim this card
                </button>
              </div>
              <div id="claim-status" class="status"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Supabase config (your project)
      const SUPABASE_URL = "https://owzdmecflzxdfbtxvfmb.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93emRtZWNmbHp4ZGZidHh2Zm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3OTY3ODYsImV4cCI6MjA3OTM3Mjc4Nn0.fUa-kAsMP-j_1QM63pgb7oX4wyuJPuZ2touDHNbtMkM";
      const TABLE_NAME = "QR Data"; // your cards table

      const { createClient } = supabase;
      const db = createClient(SUPABASE_URL, SUPABASE_KEY);

      let currentCardUID = null;

      const authStatusEl = document.getElementById("auth-status");
      const usernameStatusEl = document.getElementById("username-status");
      const claimStatusEl = document.getElementById("claim-status");

      const cardEmptyEl = document.getElementById("card-empty");
      const cardContentEl = document.getElementById("card-content");
      const cardNameEl = document.getElementById("card-name");
      const cardRarityEl = document.getElementById("card-rarity");
      const cardOwnerEl = document.getElementById("card-owner");

      // ---------- AUTH ----------
      async function refreshAuthStatus() {
        const { data, error } = await db.auth.getSession();
        if (error) {
          authStatusEl.textContent = "Auth error.";
          authStatusEl.className = "status error";
          return;
        }
        const session = data.session;
        if (session?.user) {
          authStatusEl.textContent = `Logged in as: ${session.user.email}`;
          authStatusEl.className = "status ok";
        } else {
          authStatusEl.textContent = "Not logged in.";
          authStatusEl.className = "status";
        }
      }

      document.getElementById("login").onclick = async () => {
        claimStatusEl.textContent = "";
        usernameStatusEl.textContent = "";

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!email || !password) {
          authStatusEl.textContent = "Please enter email and password.";
          authStatusEl.className = "status error";
          return;
        }

        // Try login first
        let { data, error } = await db.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          // If login fails, try sign up
          const signup = await db.auth.signUp({ email, password });
          if (signup.error) {
            authStatusEl.textContent = "Login / signup failed.";
            authStatusEl.className = "status error";
            console.error(signup.error);
          } else {
            authStatusEl.textContent =
              "Account created. Check email if confirmation is required.";
            authStatusEl.className = "status ok";
          }
        } else {
          authStatusEl.textContent = `Logged in as: ${data.user.email}`;
          authStatusEl.className = "status ok";
        }

        await refreshAuthStatus();
        await loadUsername();
      };

      // ---------- USERNAME ----------
      async function loadUsername() {
        const input = document.getElementById("username");
        input.value = "";
        usernameStatusEl.textContent = "";
        usernameStatusEl.className = "status";

        const sessionRes = await db.auth.getSession();
        const user = sessionRes.data.session?.user;
        if (!user) {
          usernameStatusEl.textContent = "Log in to set a username.";
          return;
        }

        const { data, error } = await db
          .from("profiles")
          .select("username")
          .eq("id", user.id)
          .maybeSingle();

        if (data?.username) {
          input.value = data.username;
          usernameStatusEl.textContent = "Username saved.";
          usernameStatusEl.className = "status ok";
        } else {
          usernameStatusEl.textContent =
            "Choose a username and click Save.";
        }
      }

      document.getElementById("save-username").onclick = async () => {
        const input = document.getElementById("username");
        const name = input.value.trim();
        usernameStatusEl.className = "status";

        if (!name) {
          usernameStatusEl.textContent = "Username cannot be empty.";
          usernameStatusEl.className = "status error";
          return;
        }

        const sessionRes = await db.auth.getSession();
        const user = sessionRes.data.session?.user;
        if (!user) {
          usernameStatusEl.textContent = "Log in first.";
          usernameStatusEl.className = "status error";
          return;
        }

        const { error } = await db
          .from("profiles")
          .upsert({ id: user.id, username: name });

        if (error) {
          console.error(error);
          usernameStatusEl.textContent =
            "Error saving username (maybe taken?).";
          usernameStatusEl.className = "status error";
        } else {
          usernameStatusEl.textContent = "Username saved.";
          usernameStatusEl.className = "status ok";
        }
      };

      // ---------- CARD RENDER ----------
      function showEmptyCard(message) {
        cardEmptyEl.textContent = message;
        cardEmptyEl.style.display = "block";
        cardContentEl.style.display = "none";
      }

      function showCard(name, rarity, ownerText) {
        cardNameEl.textContent = name;
        cardRarityEl.textContent = rarity.toUpperCase();
        cardOwnerEl.textContent = ownerText;

        cardEmptyEl.style.display = "none";
        cardContentEl.style.display = "block";
      }

      // ---------- LOOKUP ----------
      async function lookup(uid) {
        claimStatusEl.textContent = "";
        claimStatusEl.className = "status";
        document.getElementById("claim").disabled = true;

        const trimmed = (uid || "").trim();
        if (!trimmed) {
          showEmptyCard("Please enter a UID.");
          return;
        }

        currentCardUID = trimmed;
        document.getElementById("uid").value = trimmed;
        showEmptyCard("Loading card…");

        const { data, error } = await db
          .from(TABLE_NAME)
          .select("*")
          .eq("uid", trimmed)
          .maybeSingle();

        if (error) {
          console.error(error);
          showEmptyCard("Error talking to Supabase.");
          return;
        }

        if (!data) {
          showEmptyCard("Card not found.");
          return;
        }

        const name = data.card_name || "(no card_name)";
        const rarity = data.rarity || "(no rarity)";

        let displayRegisteredTo = "(unregistered)";

        if (data.registered_to) {
          // look up owner's username
          const { data: profile } = await db
            .from("profiles")
            .select("username")
            .eq("id", data.registered_to)
            .maybeSingle();

          const sessionRes = await db.auth.getSession();
          const currentUser = sessionRes.data.session?.user;

          if (currentUser && currentUser.id === data.registered_to) {
            const myName = profile?.username || "(no username)";
            displayRegisteredTo = `${myName} (you)`;
          } else {
            displayRegisteredTo = profile?.username || "Another player";
          }
        }

        showCard(name, rarity, displayRegisteredTo);

        // enable claim if unregistered
        document.getElementById("claim").disabled = !!data.registered_to;
        if (!data.registered_to) {
          claimStatusEl.textContent =
            "This card is unregistered. Log in and claim it.";
        } else {
          claimStatusEl.textContent = "";
        }
      }

      document.getElementById("lookup").onclick = () => {
        const uid = document.getElementById("uid").value;
        lookup(uid);
      };

      // ---------- CLAIM ----------
      document.getElementById("claim").onclick = async () => {
        claimStatusEl.textContent = "";
        claimStatusEl.className = "status";
        const button = document.getElementById("claim");

        if (!currentCardUID) {
          claimStatusEl.textContent = "Lookup a card first.";
          claimStatusEl.className = "status error";
          return;
        }

        const sessionRes = await db.auth.getSession();
        const user = sessionRes.data.session?.user;
        if (!user) {
          claimStatusEl.textContent = "You must log in first.";
          claimStatusEl.className = "status error";
          return;
        }

        button.disabled = true;

        const { data, error } = await db
          .from(TABLE_NAME)
          .update({
            registered_to: user.id,
            registered_at: new Date().toISOString(),
          })
          .eq("uid", currentCardUID)
          .is("registered_to", null) // only if still unregistered
          .select()
          .maybeSingle();

        if (error) {
          console.error(error);
          claimStatusEl.textContent =
            "Error while claiming card. Try again.";
          claimStatusEl.className = "status error";
          button.disabled = false;
          return;
        }

        if (!data) {
          claimStatusEl.textContent =
            "Too late! Someone already claimed this card.";
          claimStatusEl.className = "status error";
          await lookup(currentCardUID);
          return;
        }

        claimStatusEl.textContent = "You claimed this card!";
        claimStatusEl.className = "status ok";
        await lookup(currentCardUID);
      };

      // ---------- URL AUTO-LOAD ----------
      (function autoFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const uid = params.get("uid");
        if (uid) {
          document.getElementById("uid").value = uid;
          lookup(uid);
        } else {
          showEmptyCard("No card loaded yet. Scan a QR or enter a UID.");
        }
      })();

      // Initial status
      refreshAuthStatus();
      loadUsername();
    </script>
  </body>
</html>
