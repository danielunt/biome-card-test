<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Biome Supabase Test</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 20px;
        max-width: 400px;
        margin: 0 auto;
      }
      label,
      input,
      button {
        display: block;
        width: 100%;
        margin-bottom: 10px;
      }
      pre {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 6px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
  <h1>Biome Card Lookup & Claim</h1>

  <!-- LOGIN -->
  <h2>Account</h2>
  <label>Email</label>
  <input id="email" type="email" placeholder="you@example.com" />
  <label>Password</label>
  <input id="password" type="password" placeholder="Your password" />
  <button id="login">Log in / Sign up</button>
  <div id="auth-status"></div>

  <!-- LOOKUP -->
  <h2>Card Lookup</h2>
  <label>UID:</label>
  <input id="uid" placeholder="TEST-001" />
  <button id="lookup">Lookup Card</button>

  <pre id="result">No card loaded yet.</pre>

  <button id="claim" disabled>Claim this card</button>
  <div id="claim-status"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
      // ðŸ‘‡ FILL THESE 3 VALUES FROM SUPABASE
      const SUPABASE_URL = "https://owzdmecflzxdfbtxvfmb.supabase.co";
      const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93emRtZWNmbHp4ZGZidHh2Zm1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3OTY3ODYsImV4cCI6MjA3OTM3Mjc4Nn0.fUa-kAsMP-j_1QM63pgb7oX4wyuJPuZ2touDHNbtMkM";
      const TABLE_NAME = "QR Data"; // e.g. "cards"

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentCardUID = null;

    // ---- Login ----
    document.getElementById("login").onclick = async () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      let { data, error } = await db.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        // maybe they don't exist â†’ sign them up
        let signUp = await db.auth.signUp({ email, password });
        document.getElementById("auth-status").textContent =
          "Signed up. Check email if needed.";
      } else {
        document.getElementById("auth-status").textContent =
          "Logged in as: " + data.user.email;
      }
    };

    // ---- Lookup ----
    async function lookup(uid) {
      const r = document.getElementById("result");
      currentCardUID = uid;
      r.textContent = "Loading...";

      let { data, error } = await db
        .from(TABLE_NAME)
        .select("*")
        .eq("uid", uid)
        .maybeSingle();

      if (!data) {
        r.textContent = "Card not found.";
        document.getElementById("claim").disabled = true;
        return;
      }

      const name = data.card_name || "(no card_name)";
      const rarity = data.rarity || "(no rarity)";

      let displayRegisteredTo = "(unregistered)";

      if (data.registered_to) {
        // check logged-in user
        const sessionRes = await db.auth.getSession();
        const currentUser = sessionRes.data.session?.user;

        if (currentUser && currentUser.id === data.registered_to) {
          displayRegisteredTo = `${currentUser.email} (you)`;
        } else {
          displayRegisteredTo = "Another player";
        }
      }

      r.textContent =
        `Card Name: ${name}\n` +
        `Rarity: ${rarity}\n` +
        `Registered To: ${displayRegisteredTo}\n`;


      // enable claim if unregistered
      document.getElementById("claim").disabled = !!data.registered_to;
    }

    document.getElementById("lookup").onclick = () => {
      const uid = document.getElementById("uid").value;
      lookup(uid);
    };

    // ---- Claim ----
    document.getElementById("claim").onclick = async () => {
      const cs = document.getElementById("claim-status");

      // need a user
      const session = await db.auth.getSession();
      if (!session.data.session) {
        cs.textContent = "You must log in first.";
        return;
      }

      const userId = session.data.session.user.id;

      let { data, error } = await db
        .from(TABLE_NAME)
        .update({
          registered_to: userId,
          registered_at: new Date().toISOString(),
        })
        .eq("uid", currentCardUID)
        .is("registered_to", null) // CLAIM ONLY IF STILL UNREGISTERED
        .select()
        .maybeSingle();

      if (!data) {
        cs.textContent = "Too late, someone claimed it first!";
        lookup(currentCardUID);
        return;
      }

      cs.textContent = "You claimed this card!";
      lookup(currentCardUID);
    };

    // ---- Auto-load from URL ----
    const params = new URLSearchParams(window.location.search);
    if (params.get("uid")) {
      const auto = params.get("uid");
      document.getElementById("uid").value = auto;
      lookup(auto);
    }
  </script>
</body>


</html>
